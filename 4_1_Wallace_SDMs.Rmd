---
title: "SDMs with Wallace"
author: "Cory Merow"
date: "1/25/2017"
output:
  html_document:
    code_folding: show
---

```{r, echo=FALSE, message=FALSE, results='hide', purl=FALSE, include=FALSE}
input  = knitr::current_input()  # filename of input document
output = paste(tools::file_path_sans_ext(input), 'R', sep = '.')
knitr::opts_chunk$set(cache=TRUE)
knitr::read_chunk('cm_knitr_settings.r')
```

<!-- <div> -->
<!-- <object data="4_1_assets/Wallace_SDMs1.pdf" type="application/pdf" width="100%" height="650px">  -->
<!--   <p>It appears you don't have a PDF plugin for this browser. -->
<!--    No biggie... you can <a href="4_1_assets/Wallace_SDMs1.pdf">click here to -->
<!--   download the PDF file.</a></p>   -->
<!--  </object> -->
<!--  </div> -->

<!--  <p><a href="4_1_assets/Wallace_SDMs1.pdf">Download the PDF of the presentation</a></p>   -->

[<i class="fa fa-file-code-o fa-3x" aria-hidden="true"></i> The R Script associated with this page is available here](`r output`).  Download this file and open it (or copy-paste into a new script) with RStudio so you can follow along.  

# Setup
For `wallace` to work, you need the latest version of R.

[Windows](https://cran.r-project.org/bin/windows/base/)

[Mac](https://cran.r-project.org/bin/macosx/)

Load necessary libraries. 
```{r, message=F,eval=FALSE}
install.packages('knitr',dep=T) # you need the latest version, even if you already have it
install.pacakges('wallace',dep=T)
library(wallace)
run_wallace() # this will open the Wallace GUI in a web browser
```

The `wallace` GUI will open in your web browser and the R command line will be occupied (you only get a prompt back by pushing 'escape'). If you find this annoying and want to use your typical R command line, open a terminal window, type `R` to start R, and then run the lines above in that window. This will tie up your terminal window but not your usual R command line (e.g. RStudio, or the R GUI).

Typing `run_wallace()` will give you the following in your web browser:

![](4_1_assets/Wallace_Intro.png)


# Get Occurrence Data

Start by getting about 300 records of *Acer rubrum* (red maple) from GBIF. Throughout, I'll use a red arrow in the images below to indicate which buttons I'm referring to.


![](4_1_assets/Wallace1a.png)

While you're at it, download the data for later use (bottom left).

Notice that there are tabs along the top, and you can view the sources of the occurrence data. Later you can choose to ditch some if it looks suspect.


![](4_1_assets/Wallace1b.png)


Each *Module* (the tabs labeled 1-8 at the top of the screen) comes with guidance and references by select the tabs at the right.

![](4_1_assets/Wallace1c.png)


# Prep Occurrences

Now let's clean up the data. If we want to model *A. Rubrum* in the US, we can toss that odd point in Europe. Click the point to see it's info and then enter the ID at the left to remove it.

![](4_1_assets/Wallace2a.png)

The samples may exhibit spatial autocorrelation, which is best to account for in the model or remove before modeling. For example, there might be a bunch of samples near cities because these are mostly from iNaturalist (citizen science) and citizen often live near cities. So lets spatially thin the points and make sure they're all at least 10km from one another. It takes a sec. That left me with 163 points for modeling (yours may be different).


![](4_1_assets/Wallace2b.png)

Download these points for later reference.

# Get environmental data

Now we need some covariates to describe occurrence patterns. Worldclim is global climate data base that is very popular to both use and complain about. It seems pretty good in regions with lots of weather stations, but has issues, especially with precipitation-related things. Lesson: statistical models have problems if you don't have data. So its perfectly good for coarse resolution work, and was a decade ahead of competitors that are only emerging now. We'll add those to Wallace eventually.

Choose the *10 arcmin* data and press download. The first time you use `wallace` these data are slowly downloaded; after that you don't have to wait. *Don't select finer resolution* or you'll be downloading while the rest of us are modeling. 

![](4_1_assets/Wallace3a.png)
Notice that the log window notes that one point was discarded because environmental data were not available.


# Prep environmental data

Now we need to choose the extent of the modeling domain. This jargon means that we have to define a sensible region to fit the model. Contrary to many publications, species ranges are not typically best modeling on domains defined by squares or political boundaries. Press some buttons on this screen to explore the options, but end up with something like what I show below. We'll explore the consequences shortly. Press the *Mask* button to trim the environmental layers to this polygon and download the result.

![](4_1_assets/Wallace4a.png)


# Partition occurrences




# Model

# Visualize

# Map

# Post-processing (e.g. Richness)
At the moment we don't have anything built into `wallace` for this step, so you can use R directly with the code creates above.

First, you'll need to extract the .Rmd of your analysis.

